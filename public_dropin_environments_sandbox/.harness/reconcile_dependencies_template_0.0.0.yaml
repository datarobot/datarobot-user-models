template:
  name: reconcile dependencies template
  identifier: reconcile_dependencies_template
  versionLabel: 0.0.0
  type: Pipeline
  projectIdentifier: datarobotusermodels
  orgIdentifier: Custom_Models
  spec:
    properties:
      ci:
        codebase:
          connectorRef: account.svc_harness_git1
          repoName: datarobot-user-models
          build: <+input>
    stages:
      - stage:
          name: reconcile_dependencies
          identifier: reconcile_dependencies
          description: ""
          type: CI
          spec:
            cloneCodebase: true
            caching:
              enabled: true
            buildIntelligence:
              enabled: true
            infrastructure:
              type: KubernetesDirect
              spec:
                connectorRef: account.cigeneral
                namespace: harness-delegate-ng
                automountServiceAccountToken: true
                nodeSelector: {}
                os: Linux
            execution:
              steps:
                - step:
                    type: Run
                    name: reconcile_dependencies
                    identifier: reconcile_dependencies
                    spec:
                      connectorRef: account.dockerhub_datarobot_read
                      image: <+pipeline.variables.image_uri>
                      shell: Bash
                      command: |-
                        # Navigate to environment directory
                        ENV_DIR=<+pipeline.variables.env_dir>
                        cd "$ENV_DIR" || exit 1

                        # Ensure Git is installed
                        if ! command -v git &> /dev/null; then
                            echo "Git is not installed. Installing..."
                            apt-get update && apt-get install -y git
                        fi

                        # Configure Git
                        git config --global user.name "svc-harness-git2"
                        git config --global user.email "svc-harness-git2@datarobot.com"
                        git config --global url."https://${GITHUB_ACCESS_TOKEN}@github.com/".insteadOf "https://github.com/"
                        git config --global --add safe.directory /harness  # Mark /harness as a safe directory

                        # Commit and push changes if any
                        if [[ -n $(git status --porcelain) ]]; then
                            git add .
                            git commit -m "Reconcile dependencies for $ENV_DIR"
                            git config pull.rebase true
                            git pull origin "$(git branch --show-current)" --rebase
                            git push --set-upstream origin "$(git branch --show-current)"
                        else
                            echo "No changes detected in Git."
                        fi
                      envVariables:
                        GITHUB_ACCESS_TOKEN: <+secrets.getValue("account.githubpatsvcharnessgit2")>
                      resources:
                        limits:
                          memory: 5Gi
                    description: Run the tools/reconcile_dependencies.sh script to auto-generate requirements.txt file base on its requirements.in file.
    variables:
      - name: env_dir
        type: String
        description: The directory of the environment to reconcile, e.g. "public_dropin_environments_sandbox/python3_keras"
        required: true
        value: <+input>
      - name: image_uri
        type: String
        description: The image URI to use for the reconcile_dependencies step. Preferably, the same image used as the base image for the environment, e.g. "datarobot/dropin-env-base:1.0.0-python-3.11.11-slim-bookworm"
        required: true
        value: <+input>
